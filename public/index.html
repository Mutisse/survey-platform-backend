<!DOCTYPE html>
<html>
<head>
    <title>Teste API Admin - Ver Dados JSON</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { margin: 5px; padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .success { color: green; }
        .error { color: red; }
        .json {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        #results { margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 5px; }
        .endpoint-data { margin-bottom: 20px; }
        .data-title { font-weight: bold; margin-bottom: 5px; color: #333; }
    </style>
</head>
<body>
    <h1>Teste de Endpoints Admin - Visualizar Dados JSON</h1>

    <div>
        <label>Token de Autentica√ß√£o:</label><br>
        <input type="text" id="token" style="width: 500px; padding: 5px;"
               placeholder="Cole seu token aqui (obtido no login)">
    </div>

    <h3>Endpoints GET:</h3>
    <button onclick="testEndpoint('/admin/dashboard', 'dashboard')">Dashboard</button>
    <button onclick="testEndpoint('/admin/stats', 'stats')">Stats</button>
    <button onclick="testEndpoint('/admin/users', 'users')">Usu√°rios</button>
    <button onclick="testEndpoint('/admin/transactions/recent', 'transactions')">Transa√ß√µes Recentes</button>
    <button onclick="testEndpoint('/admin/surveys', 'surveys')">Pesquisas</button>
    <button onclick="testEndpoint('/admin/activity', 'activity')">Atividade</button>

    <h3>Endpoints POST/PUT/DELETE:</h3>
    <button onclick="testCreateUser()">Criar Usu√°rio</button>
    <button onclick="testExportUsers()">Exportar Usu√°rios</button>
    <button onclick="testProcessPayments()">Processar Pagamentos</button>

    <h3>Testar Todos:</h3>
    <button onclick="testAllEndpoints()" style="background: #28a745;">Testar Todos os Endpoints</button>

    <h3>Dados Recebidos:</h3>
    <div id="jsonData"></div>

    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api';

        function getToken() {
            return document.getElementById('token').value.trim();
        }

        function log(message, isError = false) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function displayJSON(endpointName, data) {
            const container = document.getElementById('jsonData');
            const endpointDiv = document.createElement('div');
            endpointDiv.className = 'endpoint-data';

            const title = document.createElement('div');
            title.className = 'data-title';
            title.textContent = `üìä ${endpointName.toUpperCase()}`;

            const jsonDiv = document.createElement('div');
            jsonDiv.className = 'json';
            jsonDiv.textContent = JSON.stringify(data, null, 2);

            endpointDiv.appendChild(title);
            endpointDiv.appendChild(jsonDiv);
            container.appendChild(endpointDiv);
        }

        async function testEndpoint(endpoint, endpointName = null) {
            const token = getToken();
            if (!token) {
                log('Erro: Token n√£o informado', true);
                return;
            }

            const url = `${API_BASE}${endpoint}`;
            const options = {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            };

            try {
                log(`Enviando: GET ${endpoint}`);
                const response = await fetch(url, options);
                const result = await response.json();

                if (response.ok) {
                    log(`‚úì GET ${endpoint} - Status: ${response.status}`);

                    // Exibir dados JSON
                    if (endpointName) {
                        displayJSON(endpointName, result);
                    }

                    // Mostrar resumo no console
                    console.log(`=== DADOS DE ${endpoint.toUpperCase()} ===`);
                    console.log(result);

                    return { success: true, status: response.status, data: result };
                } else {
                    log(`‚úó GET ${endpoint} - Status: ${response.status} - ${result.message || 'Erro'}`, true);
                    return { success: false, status: response.status, data: result };
                }
            } catch (error) {
                log(`‚úó Erro em ${endpoint}: ${error.message}`, true);
                return { success: false, error };
            }
        }

        async function testAllEndpoints() {
            const jsonData = document.getElementById('jsonData');
            jsonData.innerHTML = '<p>Carregando dados...</p>';

            log('=== INICIANDO TESTES DE TODOS OS ENDPOINTS ===');

            const endpoints = [
                { path: '/admin/dashboard', name: 'dashboard' },
                { path: '/admin/stats', name: 'stats' },
                { path: '/admin/users', name: 'users' },
                { path: '/admin/transactions/recent', name: 'transactions_recent' },
                { path: '/admin/surveys', name: 'surveys' },
                { path: '/admin/activity', name: 'activity' }
            ];

            jsonData.innerHTML = ''; // Limpar

            for (const endpoint of endpoints) {
                await testEndpoint(endpoint.path, endpoint.name);
                await new Promise(resolve => setTimeout(resolve, 500)); // Pequena pausa
            }

            log('=== TESTES CONCLU√çDOS ===');
        }

        async function testCreateUser() {
            const newUser = {
                name: "Usu√°rio Teste",
                email: "teste@example.com",
                role: "participant",
                phone: "841111111",
                institution: "Institui√ß√£o Teste"
            };

            const token = getToken();
            if (!token) {
                log('Erro: Token n√£o informado', true);
                return;
            }

            const url = `${API_BASE}/admin/users`;
            const options = {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(newUser)
            };

            try {
                log('Criando usu√°rio...');
                const response = await fetch(url, options);
                const result = await response.json();

                if (response.ok) {
                    log(`‚úì Usu√°rio criado com sucesso! ID: ${result.data?.id || 'N/A'}`);
                    displayJSON('user_created', result);
                } else {
                    log(`‚úó Erro ao criar usu√°rio: ${result.message || 'Erro desconhecido'}`, true);
                }
            } catch (error) {
                log(`‚úó Erro ao criar usu√°rio: ${error.message}`, true);
            }
        }

        async function testExportUsers() {
            const token = getToken();
            if (!token) {
                log('Erro: Token n√£o informado', true);
                return;
            }

            const url = `${API_BASE}/admin/users/export`;
            const options = {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'text/csv'
                }
            };

            try {
                log('Exportando usu√°rios...');
                const response = await fetch(url, options);

                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = `usuarios_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    log('‚úì Usu√°rios exportados com sucesso!');
                } else {
                    log(`‚úó Erro ao exportar: Status ${response.status}`, true);
                }
            } catch (error) {
                log(`‚úó Erro ao exportar usu√°rios: ${error.message}`, true);
            }
        }

        async function testProcessPayments() {
            const token = getToken();
            if (!token) {
                log('Erro: Token n√£o informado', true);
                return;
            }

            const url = `${API_BASE}/admin/transactions/process-payments`;
            const options = {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            };

            try {
                log('Processando pagamentos...');
                const response = await fetch(url, options);
                const result = await response.json();

                if (response.ok) {
                    log(`‚úì Pagamentos processados: ${result.message || 'Sucesso'}`);
                    displayJSON('payments_processed', result);
                } else {
                    log(`‚úó Erro ao processar pagamentos: ${result.message || 'Erro desconhecido'}`, true);
                }
            } catch (error) {
                log(`‚úó Erro ao processar pagamentos: ${error.message}`, true);
            }
        }

        // Fun√ß√£o para limpar todos os dados exibidos
        function clearData() {
            document.getElementById('jsonData').innerHTML = '';
            document.getElementById('results').innerHTML = '';
        }

        // Adicionar bot√£o para limpar dados
        document.addEventListener('DOMContentLoaded', function() {
            const buttonDiv = document.querySelector('h3:last-of-type');
            const clearBtn = document.createElement('button');
            clearBtn.textContent = 'Limpar Dados';
            clearBtn.style.background = '#dc3545';
            clearBtn.onclick = clearData;
            buttonDiv.parentNode.insertBefore(clearBtn, buttonDiv.nextSibling);
        });
    </script>
</body>
</html>
